name: "AI Issue: Stage 3 - Fix"

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number
  issue_comment:
    types: [created]

env:
  DAILY_LIMIT: 3

jobs:
  fix:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Check trigger conditions
        id: trigger
        run: |
          echo "=== Trigger Check ==="
          echo "Event: ${{ github.event_name }}"
          echo "Input issue_number: ${{ inputs.issue_number }}"

          SHOULD_RUN="false"
          SKIP_REASON=""
          NEEDS_AUTH="false"

          # workflow_call passes inputs.issue_number, but github.event_name stays as original event (e.g., 'issues')
          # So we detect workflow_call by checking if inputs.issue_number is set
          if [ -n "${{ inputs.issue_number }}" ]; then
            echo "‚úÖ Trigger via workflow_call or workflow_dispatch (issue_number=${{ inputs.issue_number }})"
            SHOULD_RUN="true"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENTER_TYPE="${{ github.event.comment.user.type }}"
            echo "Comment body: $COMMENT_BODY"
            echo "Commenter type: $COMMENTER_TYPE"

            if echo "$COMMENT_BODY" | grep -q "@ai-issue fix"; then
              if [ "$COMMENTER_TYPE" != "Bot" ]; then
                echo "‚úÖ @ai-issue fix command detected from non-bot user"
                SHOULD_RUN="true"
                NEEDS_AUTH="true"
              else
                SKIP_REASON="@ai-issue fix command from Bot is ignored"
              fi
            else
              SKIP_REASON="Comment does not contain '@ai-issue fix' command"
            fi
          else
            SKIP_REASON="Unknown trigger: event=${{ github.event_name }}, no issue_number input"
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "skip_reason=$SKIP_REASON" >> $GITHUB_OUTPUT
          echo "needs_auth=$NEEDS_AUTH" >> $GITHUB_OUTPUT

          if [ "$SHOULD_RUN" = "false" ]; then
            echo "‚ö†Ô∏è Skipping: $SKIP_REASON"
          fi

      - uses: actions/checkout@v4
        if: steps.trigger.outputs.needs_auth == 'true'

      - name: Check CODEOWNERS permission
        if: steps.trigger.outputs.needs_auth == 'true'
        id: auth
        run: |
          COMMENTER="${{ github.event.comment.user.login }}"

          # Parse CODEOWNERS file - extract all @usernames
          OWNERS=$(grep -oE '@[a-zA-Z0-9_-]+' .github/CODEOWNERS | sort -u | tr '\n' ' ')

          if echo "$OWNERS" | grep -qw "@$COMMENTER"; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "‚úÖ $COMMENTER is a CODEOWNER"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "‚ùå $COMMENTER is not a CODEOWNER"
          fi

      - name: Check preconditions
        if: |
          steps.trigger.outputs.should_run == 'true' &&
          (steps.trigger.outputs.needs_auth != 'true' || steps.auth.outputs.authorized == 'true')
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # inputs.issue_number is set for workflow_call and workflow_dispatch
          if [ -n "${{ inputs.issue_number }}" ]; then
            ISSUE_NUM=${{ inputs.issue_number }}
          else
            ISSUE_NUM=${{ github.event.issue.number }}
          fi
          echo "issue_num=$ISSUE_NUM" >> $GITHUB_OUTPUT

          # Check daily limit
          TODAY=$(date -u +%Y-%m-%d)
          COUNT=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/ai-issue-3-fix.yml/runs?status=success&created=>=$TODAY" \
            --jq '.total_count')

          echo "Today's runs: $COUNT / $DAILY_LIMIT"
          if [ "$COUNT" -ge "$DAILY_LIMIT" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Daily limit reached ($COUNT/$DAILY_LIMIT)" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Skip notification
        if: |
          steps.trigger.outputs.should_run != 'true' ||
          (steps.trigger.outputs.needs_auth == 'true' && steps.auth.outputs.authorized != 'true') ||
          steps.check.outputs.skip == 'true'
        run: |
          if [ "${{ steps.trigger.outputs.should_run }}" != "true" ]; then
            echo "‚ö†Ô∏è Trigger condition not met: ${{ steps.trigger.outputs.skip_reason }}"
          elif [ "${{ steps.trigger.outputs.needs_auth }}" = "true" ] && [ "${{ steps.auth.outputs.authorized }}" != "true" ]; then
            echo "‚ö†Ô∏è Authorization failed: ${{ github.event.comment.user.login }} is not a CODEOWNER"
          else
            echo "‚ö†Ô∏è Precondition not met: ${{ steps.check.outputs.reason }}"
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.skip == 'false'

      - name: Setup Java
        if: steps.check.outputs.skip == 'false'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Python
        if: steps.check.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        if: steps.check.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        if: steps.check.outputs.skip == 'false'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Gather context
        if: steps.check.outputs.skip == 'false'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_num }}

          # Get full issue details including comments
          gh issue view $ISSUE_NUM --json title,body,labels,comments > /tmp/issue.json

          # Extract title for PR
          ISSUE_TITLE=$(cat /tmp/issue.json | jq -r '.title')
          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

          # Extract issue body
          cat /tmp/issue.json | jq -r '.body // ""' > /tmp/issue_body.txt

          # Extract all comments in chronological order with author info
          # This includes AI Deep Analysis and any follow-up Q&A from humans
          cat /tmp/issue.json | jq -r '.comments[] | "### Comment by \(.author.login):\n\(.body)\n"' > /tmp/all_comments.txt || true

      - name: Pre-fix build & test
        if: steps.check.outputs.skip == 'false'
        id: pre_build
        run: |
          echo "Running build-all.sh to verify baseline..."
          chmod +x ./scripts/build-all.sh
          if ./scripts/build-all.sh; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Pre-fix build & test passed"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå Pre-fix build & test failed (baseline is broken)"
          fi

      - name: Run fix
        if: steps.check.outputs.skip == 'false'
        id: fix
        timeout-minutes: 30
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_num }}
          ISSUE_TITLE="${{ steps.context.outputs.title }}"
          ISSUE_BODY=$(cat /tmp/issue_body.txt 2>/dev/null || echo "")
          ALL_COMMENTS=$(cat /tmp/all_comments.txt 2>/dev/null || echo "No comments")

          # Create branch
          BRANCH="ai-fix/issue-$ISSUE_NUM"
          git checkout -b "$BRANCH"

          # Build prompt with full issue context
          FIX_PROMPT=$(cat <<'FIX_EOF'
          You are fixing GitHub issue #ISSUE_NUM_PLACEHOLDER.

          ## Issue Title
          ISSUE_TITLE_PLACEHOLDER

          ## Issue Body
          ISSUE_BODY_PLACEHOLDER

          ## Discussion Thread (All Comments)
          The following is the complete discussion thread including AI analysis and any follow-up questions/answers from humans:

          ALL_COMMENTS_PLACEHOLDER

          ## Instructions
          Based on the issue description and the ENTIRE discussion thread above:
          1. First, understand the issue by reading the original description and ALL comments (including any clarifications or additional context provided after the AI analysis)
          2. Locate the affected files
          3. Understand the root cause and decide on the approach
          4. **Write a test that reproduces the issue BEFORE implementing the fix** - The test should fail before the fix and pass after. This is required for code changes (bug fixes, new features, logic changes). Skip only for non-code changes (documentation, config files, typos, comments).
          5. Implement the fix
          6. Verify all tests pass (including any new tests you added)
          7. Ensure the build succeeds
          8. Only make minimal, focused changes

          ## Output Format
          After completing the fix, output a summary in the following format:

          ---FIX_SUMMARY_START---
          UNDERSTANDING: <Your understanding of the issue based on the description and all comments. Summarize what the problem is, what was discussed, and what approach you decided to take.>
          SUCCESS: true/false
          TEST_ADDED: <name and location of the test file(s) added, or "N/A - non-code change" if not applicable>
          CHANGES: <list of files changed and why>
          VERIFICATION: <how you verified the fix works - must include test results>
          ---FIX_SUMMARY_END---

          Do NOT create a PR - just make the code changes and verify they work.
          FIX_EOF
          )

          # Replace placeholders
          FIX_PROMPT="${FIX_PROMPT//ISSUE_NUM_PLACEHOLDER/$ISSUE_NUM}"
          FIX_PROMPT="${FIX_PROMPT//ISSUE_TITLE_PLACEHOLDER/$ISSUE_TITLE}"
          FIX_PROMPT="${FIX_PROMPT//ISSUE_BODY_PLACEHOLDER/$ISSUE_BODY}"
          FIX_PROMPT="${FIX_PROMPT//ALL_COMMENTS_PLACEHOLDER/$ALL_COMMENTS}"

          # Save prompt to file (avoid argument length limits)
          echo "$FIX_PROMPT" > /tmp/fix_prompt.txt

          FIX_RESULT=$(cat /tmp/fix_prompt.txt | npx -y @anthropic-ai/claude-code \
            --print \
            --verbose \
            --allowedTools "Read,Glob,Grep,Edit,Write,Bash" \
            2>&1 || echo "FIX_FAILED")

          echo "=== Fix Result ==="
          echo "$FIX_RESULT"
          echo "=================="

          # Save full output for PR body
          echo "$FIX_RESULT" > /tmp/fix_result.txt

          # Extract summary section if present
          SUMMARY_SECTION=$(sed -n '/---FIX_SUMMARY_START---/,/---FIX_SUMMARY_END---/p' /tmp/fix_result.txt | sed '1d;$d' || echo "")
          echo "$SUMMARY_SECTION" > /tmp/fix_summary.txt

          # Check if fix was successful (has changes)
          if [ -n "$(git status --porcelain)" ]; then
            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only HEAD)
            echo "$CHANGED_FILES" > /tmp/changed_files.txt

            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "success=false" >> $GITHUB_OUTPUT
            echo "fail_reason=No changes were made" >> $GITHUB_OUTPUT
          fi

      - name: Post-fix build & test
        if: steps.check.outputs.skip == 'false' && steps.fix.outputs.has_changes == 'true'
        id: post_build
        run: |
          echo "Running build-all.sh to verify fix..."
          chmod +x ./scripts/build-all.sh
          if ./scripts/build-all.sh; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Post-fix build & test passed"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå Post-fix build & test failed"
          fi

      - name: Commit and push
        if: steps.check.outputs.skip == 'false' && steps.fix.outputs.has_changes == 'true' && steps.post_build.outputs.success == 'true'
        id: commit
        env:
          ISSUE_NUM: ${{ steps.check.outputs.issue_num }}
          ISSUE_TITLE: ${{ steps.context.outputs.title }}
          BRANCH: ${{ steps.fix.outputs.branch }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: resolve issue #$ISSUE_NUM - $ISSUE_TITLE

          ü§ñ Generated with Claude Code

          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin "$BRANCH"

          echo "success=true" >> $GITHUB_OUTPUT

      - name: Create pull request
        if: steps.check.outputs.skip == 'false' && steps.commit.outputs.success == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ steps.fix.outputs.branch }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_num }}
          ISSUE_TITLE="${{ steps.context.outputs.title }}"

          SUMMARY_SECTION=$(cat /tmp/fix_summary.txt)
          CHANGED_FILES=$(cat /tmp/changed_files.txt)

          # Extract understanding section from summary
          UNDERSTANDING=$(echo "$SUMMARY_SECTION" | sed -n 's/^UNDERSTANDING: //p' | head -1)
          if [ -z "$UNDERSTANDING" ]; then
            UNDERSTANDING="(No understanding summary provided)"
          fi

          # Build PR body
          PR_BODY=$(cat <<EOF
          ## Summary
          Automated fix for #$ISSUE_NUM: **$ISSUE_TITLE**

          ## AI's Understanding of the Issue
          > $UNDERSTANDING

          ## AI Fix Details
          \`\`\`
          $SUMMARY_SECTION
          \`\`\`

          ## Changed Files
          \`\`\`
          $CHANGED_FILES
          \`\`\`

          ## Test Plan
          - [ ] Tests pass
          - [ ] Build succeeds
          - [ ] Manual verification

          ---
          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Closes #$ISSUE_NUM
          EOF
          )

          # Create PR
          PR_URL=$(gh pr create \
            --title "fix: resolve issue #$ISSUE_NUM - $ISSUE_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: "Result: Success"
        if: steps.check.outputs.skip == 'false' && steps.commit.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.pr.outputs.pr_url }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_num }}

          COMMENT=$(cat <<EOF
          ## üéâ Auto-Fix Complete

          I've analyzed this issue and created a fix!

          **Pull Request:** $PR_URL

          ‚úÖ All builds and tests passed before creating this PR.

          Please review the changes and merge if everything looks good.

          ---
          ü§ñ *This fix was generated by AI and may be inaccurate or inappropriate. Please review carefully before merging!*
          EOF
          )

          gh issue comment $ISSUE_NUM --body "$COMMENT"

          # Remove fix/auto-eligible label (PR is created)
          gh issue edit $ISSUE_NUM --remove-label "fix/auto-eligible"

      - name: "Result: Build Failed"
        if: steps.check.outputs.skip == 'false' && steps.fix.outputs.has_changes == 'true' && steps.post_build.outputs.success != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_num }}

          COMMENT=$(cat <<EOF
          ## ‚ö†Ô∏è Auto-Fix Failed - Build/Test Error

          I made code changes but they **failed the build or tests**.

          The changes were not pushed because they would break the codebase.

          This issue will need manual attention.

          ---
          ü§ñ *This is an automated response generated by AI.*
          EOF
          )

          gh issue comment $ISSUE_NUM --body "$COMMENT"

          # Remove fix/auto-eligible label, add fix/manual-required
          gh issue edit $ISSUE_NUM --remove-label "fix/auto-eligible" --add-label "fix/manual-required"

      - name: "Result: No Changes"
        if: steps.check.outputs.skip == 'false' && steps.fix.outputs.has_changes != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_num }}

          COMMENT=$(cat <<EOF
          ## ‚ö†Ô∏è Auto-Fix Failed

          I attempted to automatically fix this issue, but **no changes were made**.

          This issue will need manual attention. The AI analysis from Stage 2 should still be helpful for understanding the problem.

          ---
          ü§ñ *This is an automated response generated by AI.*
          EOF
          )

          gh issue comment $ISSUE_NUM --body "$COMMENT"

          # Remove fix/auto-eligible label, add fix/manual-required
          gh issue edit $ISSUE_NUM --remove-label "fix/auto-eligible" --add-label "fix/manual-required"
