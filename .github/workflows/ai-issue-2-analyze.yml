name: "AI Issue: Stage 2 - Analyze"

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

env:
  DAILY_LIMIT: 20

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: read
    outputs:
      action: ${{ steps.analysis.outputs.action }}
      issue_number: ${{ steps.check.outputs.issue_number }}

    steps:
      - name: Check trigger conditions
        id: trigger
        run: |
          echo "=== Trigger Check ==="
          echo "Event: ${{ github.event_name }}"
          echo "Input issue_number: ${{ inputs.issue_number }}"

          SHOULD_RUN="false"
          SKIP_REASON=""
          NEEDS_AUTH="false"

          # Check if called via workflow_call (inputs.issue_number is set)
          if [ -n "${{ inputs.issue_number }}" ]; then
            echo "‚úÖ Trigger via workflow_call or workflow_dispatch (issue_number=${{ inputs.issue_number }})"
            SHOULD_RUN="true"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Manual trigger via @ai-issue analyze command (requires CODEOWNERS auth)
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENTER_TYPE="${{ github.event.comment.user.type }}"
            echo "Comment body: $COMMENT_BODY"
            echo "Commenter type: $COMMENTER_TYPE"

            if echo "$COMMENT_BODY" | grep -q "@ai-issue analyze"; then
              if [ "$COMMENTER_TYPE" != "Bot" ]; then
                echo "‚úÖ @ai-issue analyze command detected from non-bot user"
                SHOULD_RUN="true"
                NEEDS_AUTH="true"
              else
                SKIP_REASON="@ai-issue analyze command from Bot is ignored"
              fi
            else
              SKIP_REASON="Comment does not contain '@ai-issue analyze' command"
            fi
          else
            SKIP_REASON="Unknown trigger: event=${{ github.event_name }}, no issue_number input"
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "skip_reason=$SKIP_REASON" >> $GITHUB_OUTPUT
          echo "needs_auth=$NEEDS_AUTH" >> $GITHUB_OUTPUT

          if [ "$SHOULD_RUN" = "false" ]; then
            echo "‚ö†Ô∏è Skipping: $SKIP_REASON"
          fi

      - uses: actions/checkout@v4
        if: steps.trigger.outputs.needs_auth == 'true'

      - name: Check CODEOWNERS permission
        if: steps.trigger.outputs.needs_auth == 'true'
        id: auth
        run: |
          COMMENTER="${{ github.event.comment.user.login }}"

          # Parse CODEOWNERS file - extract all @usernames
          OWNERS=$(grep -oE '@[a-zA-Z0-9_-]+' .github/CODEOWNERS | sort -u | tr '\n' ' ')

          echo "CODEOWNERS: $OWNERS"
          echo "Commenter: @$COMMENTER"

          if echo "$OWNERS" | grep -qw "@$COMMENTER"; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "‚úÖ $COMMENTER is a CODEOWNER"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "‚ùå $COMMENTER is not a CODEOWNER"
          fi

      - name: Check preconditions
        if: |
          steps.trigger.outputs.should_run == 'true' &&
          (steps.trigger.outputs.needs_auth != 'true' || steps.auth.outputs.authorized == 'true')
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get issue number based on event type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "workflow_call" ]; then
            ISSUE_NUM=${{ inputs.issue_number }}
          else
            ISSUE_NUM=${{ github.event.issue.number }}
          fi
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          # Check daily limit
          TODAY=$(date -u +%Y-%m-%d)
          COUNT=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/ai-issue-2-analyze.yml/runs?status=success&created=>=$TODAY" \
            --jq '.total_count')

          echo "Today's runs: $COUNT / $DAILY_LIMIT"
          if [ "$COUNT" -ge "$DAILY_LIMIT" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Daily limit reached ($COUNT/$DAILY_LIMIT)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if already analyzed (has fix/* label)
          LABELS=$(gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "^fix/"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Already analyzed (has fix/* label)" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Skip notification
        if: |
          steps.trigger.outputs.should_run != 'true' ||
          (steps.trigger.outputs.needs_auth == 'true' && steps.auth.outputs.authorized != 'true') ||
          steps.check.outputs.skip == 'true'
        run: |
          if [ "${{ steps.trigger.outputs.should_run }}" != "true" ]; then
            echo "‚ö†Ô∏è Trigger condition not met: ${{ steps.trigger.outputs.skip_reason }}"
          elif [ "${{ steps.trigger.outputs.needs_auth }}" = "true" ] && [ "${{ steps.auth.outputs.authorized }}" != "true" ]; then
            echo "‚ö†Ô∏è Authorization failed: ${{ github.event.comment.user.login }} is not a CODEOWNER"
          else
            echo "‚ö†Ô∏è Precondition not met: ${{ steps.check.outputs.reason }}"
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.skip == 'false'

      - name: Setup Node.js
        if: steps.check.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Gather context
        if: steps.check.outputs.skip == 'false'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Get full issue details
          gh issue view $ISSUE_NUM --json title,body,labels,comments > /tmp/issue.json

      - name: Run analysis
        if: steps.check.outputs.skip == 'false'
        id: analysis
        timeout-minutes: 15
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Build prompt using shared script
          .github/scripts/ai-issue/build-stage2-prompt.sh "$ISSUE_NUM" "/tmp/issue.json" > /tmp/analysis_prompt.txt

          # Run Claude Code CLI using shared script
          RESULT=$(.github/scripts/ai-issue/call-claude-code.sh /tmp/analysis_prompt.txt "Read,Glob,Grep")

          echo "=== Analysis Result ==="
          echo "$RESULT"
          echo "======================="

          # Parse response using shared script (writes files to /tmp)
          PARSED=$(echo "$RESULT" | .github/scripts/ai-issue/parse-stage2-response.sh /tmp)

          echo "=== Parsed Result ==="
          echo "$PARSED"
          echo "====================="

          # Output to GitHub Actions
          echo "$PARSED" >> $GITHUB_OUTPUT

      - name: Post analysis comment
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSIGNEE: ${{ steps.analysis.outputs.assignee }}
          PRIORITY: ${{ steps.analysis.outputs.priority }}
          ESTIMATED: ${{ steps.analysis.outputs.estimated }}
          ACTION: ${{ steps.analysis.outputs.action }}
          SCORE_TOTAL: ${{ steps.analysis.outputs.score_total }}
          SCORE_THRESHOLD: ${{ steps.analysis.outputs.score_threshold }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Read analysis from files
          SUMMARY=$(cat /tmp/analysis_summary.txt)
          EXPECTED=$(cat /tmp/expected_behavior.txt)
          CURRENT=$(cat /tmp/current_behavior.txt)
          FILES=$(cat /tmp/affected_files.txt)
          ROOT_CAUSE=$(cat /tmp/root_cause.txt)
          APPROACH=$(cat /tmp/suggested_approach.txt)
          SCORE_BREAKDOWN=$(cat /tmp/score_breakdown.txt)

          # Determine action badge based on score
          if [ "$ACTION" = "fix/auto-eligible" ]; then
            ACTION_BADGE="ü§ñ **Auto-fix eligible** - Stage 3 can attempt automatic fix"
          elif [ "$ACTION" = "fix/comment-only" ]; then
            ACTION_BADGE="üí¨ **Comment only** - No code change required"
          else
            ACTION_BADGE="üë§ **Manual fix required** - Assigned for human implementation"
          fi

          # Build comment file (avoids heredoc indentation issues)
          {
            echo "## üîç AI Deep Analysis"
            echo ""
            echo "### Summary"
            echo "$SUMMARY"
            echo ""
            if [ -n "$EXPECTED" ]; then
              echo "### Expected Behavior"
              echo "$EXPECTED"
              echo ""
            fi
            if [ -n "$CURRENT" ]; then
              echo "### Current Behavior"
              echo "$CURRENT"
              echo ""
            fi
            echo "### Affected Files"
            echo "\`$FILES\`"
            echo ""
            if [ -n "$ROOT_CAUSE" ]; then
              echo "### Root Cause"
              echo "$ROOT_CAUSE"
              echo ""
            fi
            echo "### Suggested Approach"
            echo "$APPROACH"
            echo ""
            echo "---"
            echo ""
            echo "## üìä Auto-Fix Score"
            echo ""
            echo "**Total: ${SCORE_TOTAL}/100** (Threshold: ${SCORE_THRESHOLD})"
            echo ""
            echo "$SCORE_BREAKDOWN"
            echo ""
            if [ "$SCORE_TOTAL" -ge "$SCORE_THRESHOLD" ]; then
              echo "**Result**: ü§ñ Auto-fix eligible (${SCORE_TOTAL} ‚â• ${SCORE_THRESHOLD})"
            else
              echo "**Result**: üë§ Manual fix required (${SCORE_TOTAL} < ${SCORE_THRESHOLD})"
            fi
            echo ""
            echo "---"
            echo ""
            echo "## üìã Triage Decision"
            echo ""
            echo "$ACTION_BADGE"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Priority** | $PRIORITY |"
            echo "| **Estimate** | $ESTIMATED story points |"
            echo "| **Assignee** | @$ASSIGNEE |"
            echo ""
            echo "---"
            echo "ü§ñ *This analysis was generated by AI and may be inaccurate or inappropriate. If something seems off, please let us know!*"
          } > /tmp/comment.md

          gh issue comment $ISSUE_NUM --body-file /tmp/comment.md

          # Assign to recommended member
          if [ -n "$ASSIGNEE" ]; then
            gh issue edit $ISSUE_NUM --add-assignee "$ASSIGNEE" || echo "Failed to assign to $ASSIGNEE"
          fi

      - name: Update labels
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LABELS: ${{ steps.analysis.outputs.labels }}
          ACTION: ${{ steps.analysis.outputs.action }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Build label arguments
          LABEL_ARGS=""
          for label in $(echo "$LABELS" | jq -r '.[]'); do
            # Use GitHub default labels directly (bug, documentation, enhancement)
            # Skip dependencies as it's not a standard label
            case "$label" in
              dependencies) ;; # Skip - not a standard GitHub label
              *) LABEL_ARGS="$LABEL_ARGS --add-label \"$label\"" ;;
            esac
          done

          # Add fix status label based on action
          if [ "$ACTION" = "fix/auto-eligible" ]; then
            LABEL_ARGS="$LABEL_ARGS --add-label \"fix/auto-eligible\""
          elif [ "$ACTION" = "fix/comment-only" ]; then
            LABEL_ARGS="$LABEL_ARGS --add-label \"fix/comment-only\""
          else
            LABEL_ARGS="$LABEL_ARGS --add-label \"fix/manual-required\""
          fi

          eval gh issue edit $ISSUE_NUM $LABEL_ARGS

      - name: Post response and close issue for comment-only
        if: steps.check.outputs.skip == 'false' && steps.analysis.outputs.action == 'fix/comment-only'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Read and post the comment_draft
          COMMENT_DRAFT=$(cat /tmp/comment_draft.txt)
          if [ -n "$COMMENT_DRAFT" ]; then
            echo "üí¨ Posting response comment..."
            gh issue comment $ISSUE_NUM --body "$COMMENT_DRAFT"
          fi

          echo "üí¨ Issue #$ISSUE_NUM is comment-only, closing issue..."
          gh issue close $ISSUE_NUM --comment "ü§ñ This issue has been addressed with the response above. Closing as no code changes are required."

      - name: Log Stage 3 eligibility
        if: steps.check.outputs.skip == 'false' && steps.analysis.outputs.action == 'fix/auto-eligible'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          echo "‚úÖ Issue #$ISSUE_NUM is eligible for auto-fix"
          echo "Automatically triggering Stage 3..."

  # Call Stage 3 when analysis determines auto-fix is eligible
  fix:
    needs: analyze
    if: needs.analyze.outputs.action == 'fix/auto-eligible'
    uses: ./.github/workflows/ai-issue-3-fix.yml
    with:
      issue_number: ${{ fromJson(needs.analyze.outputs.issue_number) }}
    secrets: inherit
