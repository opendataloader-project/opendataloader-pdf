name: "AI Issue: Stage 1 - Triage"

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

env:
  DAILY_LIMIT: 20  # Triage limit per day

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: read
    outputs:
      decision: ${{ steps.triage.outputs.decision }}
      issue_number: ${{ steps.valid.outputs.issue_number }}

    if: |
      github.event_name == 'workflow_dispatch' ||
      !contains(github.event.issue.labels.*.name, 'fix/')

    steps:
      - name: Check daily limit
        id: limit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check today's successful workflow runs
          TODAY=$(date -u +%Y-%m-%d)

          COUNT=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/ai-issue-1-triage.yml/runs?status=success&created=>=$TODAY" \
            --jq '.total_count')

          echo "Today's runs: $COUNT / $DAILY_LIMIT"

          if [ "$COUNT" -ge "$DAILY_LIMIT" ]; then
            echo "exceeded=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Daily limit reached ($COUNT/$DAILY_LIMIT)"
          else
            echo "exceeded=false" >> $GITHUB_OUTPUT
            echo "remaining=$((DAILY_LIMIT - COUNT))" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.limit.outputs.exceeded != 'true'
        with:
          sparse-checkout: |
            README.md
            .github/scripts/ai-issue
          sparse-checkout-cone-mode: false

      - name: Gather context
        if: steps.limit.outputs.exceeded != 'true'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number || inputs.issue_number }}

          # Get issue details (for workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_JSON=$(gh issue view $ISSUE_NUM --json title,body)
            echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "$ISSUE_JSON" | jq -r '.body // ""' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          # Fetch previous issues (number and title only)
          gh issue list --state all --limit 50 --json number,title \
            --jq ".[] | select(.number != $ISSUE_NUM) | \"#\\(.number) \\(.title)\"" \
            > /tmp/issues.txt

      - name: Run triage
        if: steps.limit.outputs.exceeded != 'true'
        id: triage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Build prompt using shared script
          ISSUE_NUM="${{ github.event.issue.number || inputs.issue_number }}"
          .github/scripts/ai-issue/build-stage1-prompt.sh \
            "$ISSUE_NUM" \
            "${{ steps.context.outputs.title }}" \
            "${{ steps.context.outputs.body }}" \
            "README.md" \
            "/tmp/issues.txt" > /tmp/triage_prompt.txt

          # Call API using shared script
          RESPONSE=$(.github/scripts/ai-issue/call-claude-api.sh /tmp/triage_prompt.txt)

          echo "=== LLM Response ==="
          echo "$RESPONSE"
          echo "===================="

          # Parse response using shared script
          PARSED=$(echo "$RESPONSE" | .github/scripts/ai-issue/parse-stage1-response.sh)

          echo "=== Parsed Result ==="
          echo "$PARSED"
          echo "====================="

          # Output to GitHub Actions
          echo "$PARSED" >> $GITHUB_OUTPUT

      - name: "Result: Close as invalid"
        if: steps.triage.outputs.decision == 'invalid'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REASON: ${{ steps.triage.outputs.reason }}
        run: |
          COMMENT=$(cat <<'EOF'
          Hi there! ðŸ‘‹

          Thank you for taking the time to open this issue. After an initial review, it appears this issue may not be directly related to this project's scope.

          **Reason:** REASON_PLACEHOLDER

          If you believe this was a mistake, please feel free to reopen this issue with additional context, or open a new issue with more details about how this relates to the project.

          ðŸ¤– *This is an automated response generated by AI and may be inaccurate or inappropriate. If something seems off, please let us know!*
          EOF
          )
          COMMENT="${COMMENT//REASON_PLACEHOLDER/$REASON}"

          gh issue close ${{ github.event.issue.number || inputs.issue_number }} \
            --reason "not planned" \
            --comment "$COMMENT"
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "wontfix"

      - name: "Result: Close as duplicate"
        if: steps.triage.outputs.decision == 'duplicate'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DUP="${{ steps.triage.outputs.duplicate_of }}"
          if [ -n "$DUP" ] && [ "$DUP" != "null" ]; then
            COMMENT=$(cat <<EOF
          Hi there! ðŸ‘‹

          Thank you for reporting this! It looks like this issue has already been discussed in #$DUP.

          To avoid splitting the conversation, we're closing this as a duplicate. Please follow **#$DUP** for updates and feel free to add any additional context there.

          ðŸ¤– *This is an automated response generated by AI and may be inaccurate or inappropriate. If something seems off, please let us know!*
          EOF
          )
          else
            COMMENT=$(cat <<'EOF'
          Hi there! ðŸ‘‹

          Thank you for reporting this! It looks like this issue may have already been discussed in an existing issue.

          We're closing this as a potential duplicate. Please search through existing issues to find the related discussion and add your input there.

          ðŸ¤– *This is an automated response generated by AI and may be inaccurate or inappropriate. If something seems off, please let us know!*
          EOF
          )
          fi

          gh issue close ${{ github.event.issue.number || inputs.issue_number }} \
            --reason "not planned" \
            --comment "$COMMENT"
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "duplicate"

      - name: "Result: Request more info"
        if: steps.triage.outputs.decision == 'needs-info'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          QUESTIONS: ${{ steps.triage.outputs.questions }}
        run: |
          QLIST=$(echo "$QUESTIONS" | jq -r 'if length > 0 then .[] | "- " + . else empty end')

          COMMENT=$(cat <<EOF
          Hi there! ðŸ‘‹

          Thank you for opening this issue! We'd love to help, but we need a bit more information to understand your situation better.

          Could you please provide some additional details?

          $QLIST

          This will help us investigate and respond more effectively. Thanks for your patience!

          ðŸ¤– *This is an automated response generated by AI and may be inaccurate or inappropriate. If something seems off, please let us know!*
          EOF
          )

          gh issue comment ${{ github.event.issue.number || inputs.issue_number }} \
            --body "$COMMENT"
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "question"

      - name: "Result: Pass to Stage 2"
        if: steps.triage.outputs.decision == 'valid'
        id: valid
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number || inputs.issue_number }}
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          echo "âœ“ Issue passed triage: ${{ steps.triage.outputs.reason }}"

  # Call Stage 2 when triage passes
  analyze:
    needs: triage
    if: needs.triage.outputs.decision == 'valid'
    uses: ./.github/workflows/ai-issue-2-analyze.yml
    with:
      issue_number: ${{ fromJson(needs.triage.outputs.issue_number) }}
    secrets: inherit
